<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reports - IT Ticketing</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
    <style>
      .reports-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .reports-table {
        display: flex;
        flex-direction: column;
      }

      .reports-table h3 {
        margin: 0 0 8px;
      }

      .reports-table table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
      }

      .reports-table th,
      .reports-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .reports-table tbody tr:last-child td {
        border-bottom: none;
      }

      .reports-loading {
        color: var(--muted);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="navbar"></div>

    <main class="container" style="padding: 16px; max-width: 1100px; margin: auto">
      <header
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          flex-wrap: wrap;
          margin-bottom: 18px;
        "
      >
        <div>
          <h2 style="margin: 0">Reports & Insights</h2>
          <p class="muted" style="margin: 4px 0 0">
            Track ticket performance and workload distribution across the team.
          </p>
        </div>
        <button id="btn-refresh" class="btn">Refresh</button>
      </header>

      <section class="reports-grid" style="margin-bottom: 18px">
        <article class="card kpi">
          <div class="muted">Open Tickets</div>
          <div class="val" id="kpi-open">0</div>
        </article>
        <article class="card kpi">
          <div class="muted">Resolved (7 days)</div>
          <div class="val" id="kpi-resolved7">0</div>
        </article>
        <article class="card kpi">
          <div class="muted">High & Critical at Risk</div>
          <div class="val" id="kpi-risk">0</div>
        </article>
      </section>

      <section class="reports-grid">
        <article class="card reports-table" style="min-height: 220px">
          <h3>By Status</h3>
          <div id="by-status" class="reports-loading">Loading…</div>
        </article>
        <article class="card reports-table" style="min-height: 220px">
          <h3>By Priority</h3>
          <div id="by-priority" class="reports-loading">Loading…</div>
        </article>
        <article class="card reports-table" style="min-height: 220px">
          <h3>By Category</h3>
          <div id="by-category" class="reports-loading">Loading…</div>
        </article>
      </section>
    </main>

    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/guard.js"></script>
    <script>
      (function () {
        const elOpen = document.getElementById("kpi-open");
        const elRes7 = document.getElementById("kpi-resolved7");
        const elRisk = document.getElementById("kpi-risk");
        const elBySt = document.getElementById("by-status");
        const elByPr = document.getElementById("by-priority");
        const elByCat = document.getElementById("by-category");
        const btnRefresh = document.getElementById("btn-refresh");
        const safeHtml =
          typeof window.escapeHtml === "function"
            ? window.escapeHtml
            : (value) =>
                String(value ?? "").replace(/([&<>"'])/g, (m) =>
                  ({
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#039;",
                  }[m])
                );

        function showLoadingState() {
          [elBySt, elByPr, elByCat].forEach((el) => {
            if (!el) return;
            el.classList.add("reports-loading");
            el.textContent = "Loading…";
          });
        }

        function tableFromMap(title, m) {
          const rows = Object.keys(m)
            .sort()
            .map((k) => {
              return `<tr><td style="padding:6px 8px">${safeHtml(
                k
              )}</td><td style="padding:6px 8px;text-align:right">${safeHtml(
                m[k]
              )}</td></tr>`;
            })
            .join("");
          return `
        <div class="table-wrap" style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="text-align:left;padding:6px 8px">${safeHtml(
                  title
                )}</th>
                <th style="text-align:right;padding:6px 8px">Count</th>
              </tr>
            </thead>
            <tbody>${
              rows ||
              `<tr><td colspan="2" class="muted" style="padding:8px">No data</td></tr>`
            }</tbody>
          </table>
        </div>`;
        }

        function countBy(arr, key) {
          const out = {};
          for (const it of arr) {
            const k = it[key] || "Unknown";
            out[k] = (out[k] || 0) + 1;
          }
          return out;
        }

        // Page through all tickets to build accurate breakdowns
        async function loadAllTickets() {
          const limit = 200;
          let offset = 0;
          let total = Infinity;
          const items = [];
          while (offset < total) {
            const { items: page, total: t } = await API.searchTickets({
              limit,
              offset,
              order: "desc",
              sort: "updated_at",
            });
            total = Number.isFinite(t) ? t : offset + page.length;
            items.push(...page);
            if (!page.length) break;
            offset += page.length;
          }
          return items;
        }

        async function load() {
          showLoadingState();
          if (btnRefresh) {
            btnRefresh.disabled = true;
            btnRefresh.textContent = "Refreshing…";
          }

          try {
            const s = await API.getReportSummary();
            elOpen.textContent = s.open ?? "0";
            elRes7.textContent = s.resolved7d ?? "0";
            elRisk.textContent = s.highCriticalOpen ?? "0";
          } catch (e) {
            console.error("[reports] summary fetch failed", e);
            elOpen.textContent = "0";
            elRes7.textContent = "0";
            elRisk.textContent = "0";
          }

          try {
            const list = await loadAllTickets();
            elBySt.innerHTML = tableFromMap("Status", countBy(list, "status"));
            elByPr.innerHTML = tableFromMap("Priority", countBy(list, "priority"));
            elByCat.innerHTML = tableFromMap("Category", countBy(list, "category"));
            [elBySt, elByPr, elByCat].forEach((el) =>
              el?.classList.remove("reports-loading")
            );
          } catch (e) {
            console.error("[reports] list fetch failed", e);
            elBySt.innerHTML = tableFromMap("Status", {});
            elByPr.innerHTML = tableFromMap("Priority", {});
            elByCat.innerHTML = tableFromMap("Category", {});
            [elBySt, elByPr, elByCat].forEach((el) =>
              el?.classList.remove("reports-loading")
            );
          } finally {
            if (btnRefresh) {
              btnRefresh.disabled = false;
              btnRefresh.textContent = "Refresh";
            }
          }
        }

        btnRefresh?.addEventListener("click", load);
        load();
      })();
    </script>
  </body>
</html>
