<script src="/assets/js/api.js"></script>
<script src="/assets/js/components.js"></script>
<script src="/assets/js/guard.js"></script>
<script>
  (function () {
    // inject navbar actions if you use components.js
    if (typeof addDefaultNav === "function") {
      // addDefaultNav can target a container; here we just render default in #navbar if you support it
      try {
        addDefaultNav();
      } catch (_) {}
    }

    const elOpen = document.getElementById("kpi-open");
    const elRes7 = document.getElementById("kpi-resolved7");
    const elRisk = document.getElementById("kpi-risk");
    const elBySt = document.getElementById("by-status");
    const elByPr = document.getElementById("by-priority");
    const elByCat = document.getElementById("by-category");

    function tableFromMap(title, m) {
      const rows = Object.keys(m)
        .sort()
        .map((k) => {
          return `<tr><td style="padding:6px 8px">${escapeHtml(
            k
          )}</td><td style="padding:6px 8px;text-align:right">${
            m[k]
          }</td></tr>`;
        })
        .join("");
      return `
        <div class="table-wrap" style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="text-align:left;padding:6px 8px">${escapeHtml(
                  title
                )}</th>
                <th style="text-align:right;padding:6px 8px">Count</th>
              </tr>
            </thead>
            <tbody>${
              rows ||
              `<tr><td colspan="2" class="muted" style="padding:8px">No data</td></tr>`
            }</tbody>
          </table>
        </div>`;
    }

    function countBy(arr, key) {
      const out = {};
      for (const it of arr) {
        const k = it[key] || "Unknown";
        out[k] = (out[k] || 0) + 1;
      }
      return out;
    }

    function escapeHtml(s) {
      return String(s).replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          }[m])
      );
    }

    // Page through all tickets to build accurate breakdowns
    async function loadAllTickets() {
      const limit = 200;
      let offset = 0;
      let total = Infinity;
      const items = [];
      while (offset < total) {
        const { items: page, total: t } = await API.searchTickets({
          limit,
          offset,
          order: "desc",
          sort: "updated_at",
        });
        total = Number.isFinite(t) ? t : offset + page.length;
        items.push(...page);
        if (!page.length) break;
        offset += page.length;
      }
      return items;
    }

    async function load() {
      // KPIs from backend (falls back to client-side if backend unavailable)
      try {
        const s = await API.getReportSummary();
        elOpen.textContent = s.open ?? "0";
        elRes7.textContent = s.resolved7d ?? "0";
        elRisk.textContent = s.highCriticalOpen ?? "0";
      } catch (e) {
        console.error(e);
        elOpen.textContent = "0";
        elRes7.textContent = "0";
        elRisk.textContent = "0";
      }

      // Breakdown from full list (pages through all results)
      try {
        const list = await loadAllTickets();
        elBySt.innerHTML = tableFromMap("Status", countBy(list, "status"));
        elByPr.innerHTML = tableFromMap("Priority", countBy(list, "priority"));
        elByCat.innerHTML = tableFromMap("Category", countBy(list, "category"));
      } catch (e) {
        console.error(e);
        elBySt.innerHTML = tableFromMap("Status", {});
        elByPr.innerHTML = tableFromMap("Priority", {});
        elByCat.innerHTML = tableFromMap("Category", {});
      }
    }

    document.getElementById("btn-refresh").onclick = load;
    load();
  })();
</script>
