<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tickets - IT Ticketing</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <!-- Global navbar -->
    <div id="navbar"></div>

    <main
      class="container"
      style="padding: 16px; max-width: 1100px; margin: auto"
    >
      <header
        style="
          display: flex;
          gap: 12px;
          align-items: center;
          flex-wrap: wrap;
          margin-bottom: 12px;
        "
      >
        <h2 style="margin: 0" data-i18n="tickets.title">Tickets</h2>
        <a class="btn" href="./create-ticket.html" style="margin-left: auto"
          ><span data-i18n="tickets.newBtn">+ New Ticket</span></a
        >
      </header>

      <!-- Filters -->
      <section class="card" style="padding: 12px; margin-bottom: 12px">
        <div
          style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center"
        >
          <input
            id="filter-q"
            class="input"
            data-i18n-attr="placeholder"
            data-i18n-placeholder="tickets.searchPlaceholder"
            style="min-width: 260px"
          />
          <select id="filter-status" class="input">
            <option value="">All statuses</option>
            <option>New</option>
            <option>Open</option>
            <option>In Progress</option>
            <option>Pending</option>
            <option>Resolved</option>
            <option>Closed</option>
          </select>

          <!-- Per-page selector to control server-side pagination -->
          <select id="filter-limit" class="input" title="Per page">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
            <option>100</option>
          </select>

          <button id="btn-apply" class="btn">Apply</button>
          <button id="btn-clear" class="btn ghost">Clear</button>

          <span id="result-count" class="muted" style="margin-left: auto"
            >â€“</span
          >
        </div>
      </section>

      <!-- Results -->
      <section id="results" class="grid" style="gap: 10px"></section>

      <!-- Pagination (server-side) -->
      <nav
        style="
          display: flex;
          gap: 8px;
          justify-content: center;
          margin-top: 14px;
        "
      >
        <button id="prev" class="btn ghost">Prev</button>
        <span id="page-indicator" class="muted"></span>
        <button id="next" class="btn ghost">Next</button>
      </nav>
    </main>

    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/i18n.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/guard.js"></script>
    <script>
      (function () {
        // Navbar is loaded by components.js automatically

        // State
        let PAGE = 1;
        let PAGE_SIZE = 20; // default matches <select>
        let TOTAL = 0; // server-reported total
        let LAST_QUERY = { q: "", status: "" };

        // DOM
        const qEl = document.getElementById("filter-q");
        const stEl = document.getElementById("filter-status");
        const limEl = document.getElementById("filter-limit");
        const resEl = document.getElementById("results");
        const prevEl = document.getElementById("prev");
        const nextEl = document.getElementById("next");
        const pageEl = document.getElementById("page-indicator");
        const countEl = document.getElementById("result-count");

        // Helpers
        function escapeHtml(s) {
          return String(s).replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#039;",
              }[m])
          );
        }

        function ticketCard(t) {
          const updated = t.updatedAt
            ? new Date(t.updatedAt)
            : t.createdAt
            ? new Date(t.createdAt)
            : null;
          const when = updated ? updated.toLocaleString() : "";

          // NEW: prefer assigneeName -> assigneeEmail -> assignee (id) -> Unassigned
          const assigneeLabel =
            (t.assigneeName && t.assigneeName.trim()) ||
            (t.assigneeEmail && t.assigneeEmail.trim()) ||
            (t.assignee && t.assignee.trim()) ||
            "";

          return `
            <article class="card ticket-card" data-id="${
              t.id
            }" style="cursor:pointer;padding:12px">
              <div style="display:flex;justify-content:space-between;gap:12px">
                <div>
                  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    <strong>${escapeHtml(t.title || "(no title)")}</strong>
                    <span class="badge">${escapeHtml(I18n.mapStatus(t.status || "New"))}</span>
                    <span class="badge ghost">${escapeHtml(
                      I18n.mapPriority(t.priority || "Low")
                    )}</span>
                    ${
                      t.category
                        ? `<span class="badge ghost">${escapeHtml(
                            t.category
                          )}</span>`
                        : ""
                    }
                  </div>
                  <div class="muted" style="margin-top:6px;max-width:80ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                    ${escapeHtml(t.description || "")}
                  </div>
                </div>
                <div style="text-align:right;min-width:220px">
                  ${
                    assigneeLabel
                      ? `<div class="muted">${escapeHtml(I18n.t('tickets.assignee'))}: ${escapeHtml(
                          assigneeLabel
                        )}</div>`
                      : `<div class="muted">${escapeHtml(I18n.t('labels.unassigned'))}</div>`
                  }
                  <div class="muted">${when}</div>
                  <div class="muted">${escapeHtml(t.alias || t.id)}</div>
                </div>
              </div>
            </article>
          `;
        }

        function emptyState() {
          return `
            <div class="card" style="padding:16px;text-align:center">
              <div class="muted">No tickets found. Try adjusting filters or create a new ticket.</div>
            </div>
          `;
        }

        async function fetchPage() {
          const offset = (PAGE - 1) * PAGE_SIZE;
          const { items, total } = await API.searchTickets({
            q: LAST_QUERY.q,
            status: LAST_QUERY.status,
            limit: PAGE_SIZE,
            offset,
            sort: "updated_at",
            order: "desc",
          });
          TOTAL = Number.isFinite(total) ? total : items.length;
          return items;
        }

        async function render() {
          const items = await fetchPage();

          // Results
          resEl.innerHTML = items.length
            ? items.map(ticketCard).join("")
            : emptyState();

          // Wire clicks
          resEl.querySelectorAll(".ticket-card").forEach((card) => {
            card.addEventListener("click", () => {
              const id = card.getAttribute("data-id");
              location.href = `./ticket-detail.html?id=${encodeURIComponent(
                id
              )}`;
            });
          });

          // Pagination UI
          const totalPages = Math.max(1, Math.ceil(TOTAL / PAGE_SIZE));
          pageEl.textContent = `Page ${PAGE} of ${totalPages}`;
          prevEl.disabled = PAGE <= 1;
          nextEl.disabled = PAGE >= totalPages;

          // Result counter
          countEl.textContent = `${TOTAL} result${TOTAL === 1 ? "" : "s"}`;
        }

        async function load() {
          LAST_QUERY = {
            q: qEl.value.trim(),
            status: stEl.value.trim(),
          };
          PAGE = 1; // reset page on new query
          PAGE_SIZE = +limEl.value || 20;
          await render();
        }

        // Events
        document.getElementById("btn-apply").onclick = load;

        document.getElementById("btn-clear").onclick = () => {
          qEl.value = "";
          stEl.value = "";
          limEl.value = "20";
          load();
        };

        prevEl.onclick = () => {
          if (PAGE > 1) {
            PAGE--;
            render();
          }
        };
        nextEl.onclick = () => {
          const max = Math.max(1, Math.ceil(TOTAL / PAGE_SIZE));
          if (PAGE < max) {
            PAGE++;
            render();
          }
        };

        limEl.onchange = () => {
          PAGE = 1;
          PAGE_SIZE = +limEl.value || 20;
          render();
        };

        // Init
        load();
      })();
    </script>
  </body>
</html>
