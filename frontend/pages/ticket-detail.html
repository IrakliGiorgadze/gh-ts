<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ticket Details</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <div class="container">
      <div class="nav">
        <div class="brand"><a href="../index.html">‚Üê Back</a></div>
        <div id="nav-actions"></div>
      </div>

      <div class="grid grid-2">
        <!-- Ticket card -->
        <div class="card">
          <h2 id="t-title" style="margin: 0 0 6px 0"></h2>

          <div class="row" style="gap: 8px">
            <span class="badge" id="t-id"></span>
            <span class="badge" id="t-priority"></span>
            <span class="badge" id="t-category"></span>
            <span class="badge" id="t-status"></span>
          </div>

          <p id="t-desc" style="margin-top: 12px"></p>

          <div class="row" id="status-row" style="gap: 8px; margin-top: 12px">
            <label>Status</label>
            <select id="sel-status" class="input" style="max-width: 240px">
              <option>New</option>
              <option>Open</option>
              <option>In Progress</option>
              <option>Pending</option>
              <option>Resolved</option>
              <option>Closed</option>
            </select>
            <button class="btn secondary" id="btn-update-status">Update</button>
            <span id="save-ok" class="badge" style="display: none">Saved</span>
            <span id="save-err" class="badge" style="display: none"
              >Save failed</span
            >
          </div>
        </div>

        <!-- Comments card -->
        <div class="card">
          <h3 style="margin-top: 0">Comments</h3>
          <div id="comments"></div>

          <div class="row" style="margin-top: 10px; align-items: stretch">
            <input
              class="input"
              id="new-comment"
              placeholder="Add a comment..."
            />
            <button class="btn" id="btn-add-comment">Comment</button>
            <span id="c-ok" class="badge" style="display: none">Added</span>
            <span id="c-err" class="badge" style="display: none">Failed</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/guard.js"></script>

    <script>
      addDefaultNav("nav-actions");

      const idParam = new URLSearchParams(location.search).get("id");
      if (!idParam) {
        alert("Missing ticket id");
        location.href = "./tickets.html";
      }

      // Hide status controls for non-staff users
      (async () => {
        try {
          const me = await Auth.me();
          const isStaff =
            me && ["admin", "agent", "supervisor"].includes(me.role);
          if (!isStaff) {
            const row =
              document.getElementById("sel-status")?.closest(".row") ||
              document.getElementById("status-row");
            if (row) row.style.display = "none";
          }
        } catch (_) {
          // if /auth/me fails, treat as non-staff
          const row =
            document.getElementById("sel-status")?.closest(".row") ||
            document.getElementById("status-row");
          if (row) row.style.display = "none";
        }
      })();

      let ticket;

      (async () => {
        try {
          ticket = await API.getTicket(idParam);
          if (!ticket) throw new Error("Ticket not found");

          byId("t-title").textContent = ticket.title || "(no title)";
          byId("t-id").textContent = `#${ticket.id}`;
          byId("t-priority").textContent = ticket.priority || "Low";
          byId("t-category").textContent = ticket.category || "General";
          byId("t-status").textContent = ticket.status || "New";
          byId("t-desc").textContent = ticket.description || "";
          byId("sel-status").value = ticket.status || "New";

          renderComments(ticket.comments || []);
        } catch (e) {
          console.error(e);
          alert("Failed to load ticket");
          location.href = "./tickets.html";
        }
      })();

      function renderComments(list) {
        const el = byId("comments");
        el.innerHTML = "";
        if (!list || !list.length) {
          el.innerHTML = '<div class="muted">No comments yet.</div>';
          return;
        }
        list.forEach((c) => {
          const div = document.createElement("div");
          div.className = "card";
          div.style.margin = "8px 0";
          const when = c.createdAt
            ? new Date(c.createdAt).toLocaleString()
            : "";
          div.innerHTML = `<div class="muted">${when}</div><div>${escapeHtml(
            c.text || ""
          )}</div>`;
          el.appendChild(div);
        });
      }

      // Status update
      byId("btn-update-status").addEventListener("click", async () => {
        const btn = byId("btn-update-status");
        const ok = byId("save-ok");
        const err = byId("save-err");
        err.style.display = "none";
        btn.disabled = true;
        try {
          const status = val("sel-status");
          const updated = await API.updateTicket(idParam, { status });
          byId("t-status").textContent = (updated && updated.status) || status;
          showBadge(ok);
        } catch (e) {
          console.error(e);
          err.textContent = "Save failed";
          err.style.display = "inline-block";
          // revert select to previous
          byId("sel-status").value = byId("t-status").textContent;
        } finally {
          btn.disabled = false;
        }
      });

      // Add comment
      byId("btn-add-comment").addEventListener("click", async () => {
        const btn = byId("btn-add-comment");
        const ok = byId("c-ok");
        const err = byId("c-err");
        err.style.display = "none";

        const text = val("new-comment").trim();
        if (!text) return;

        btn.disabled = true;
        try {
          const updated = await API.addComment(idParam, text);
          byId("new-comment").value = "";
          renderComments((updated && updated.comments) || []);
          showBadge(ok);
          // scroll to newest
          const list = byId("comments");
          list.lastElementChild &&
            list.lastElementChild.scrollIntoView({
              behavior: "smooth",
              block: "end",
            });
        } catch (e) {
          console.error(e);
          err.textContent = "Failed";
          err.style.display = "inline-block";
        } finally {
          btn.disabled = false;
        }
      });

      function showBadge(el) {
        el.style.display = "inline-block";
        setTimeout(() => (el.style.display = "none"), 1200);
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }
    </script>
  </body>
</html>
