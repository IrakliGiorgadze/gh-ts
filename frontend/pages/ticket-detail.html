<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ticket Details</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <div class="container">
      <div class="nav">
        <div class="brand"><a href="../index.html">‚Üê Back</a></div>
        <div id="nav-actions"></div>
      </div>

      <div class="grid grid-2">
        <!-- Ticket card -->
        <div class="card">
          <h2 id="t-title" style="margin: 0 0 6px 0"></h2>

          <div class="row" style="gap: 8px">
            <span class="badge" id="t-id"></span>
            <span class="badge" id="t-priority"></span>
            <span class="badge" id="t-category"></span>
            <span class="badge" id="t-status"></span>
          </div>

          <p id="t-desc" style="margin-top: 12px"></p>

          <div style="margin-top: 12px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
            <div class="muted" style="font-size: 0.9em; margin-bottom: 4px">Current Assignee</div>
            <div id="t-assignee-display" style="font-weight: 500"></div>
          </div>

          <div class="row" id="status-row" style="gap: 8px; margin-top: 12px">
            <label>Status</label>
            <select id="sel-status" class="input" style="max-width: 240px">
              <option>New</option>
              <option>Open</option>
              <option>In Progress</option>
              <option>Pending</option>
              <option>Resolved</option>
              <option>Closed</option>
            </select>
            <button class="btn secondary" id="btn-update-status">Update</button>
            <span id="save-ok" class="badge" style="display: none">Saved</span>
            <span id="save-err" class="badge" style="display: none"
              >Save failed</span
            >
          </div>

          <div class="row" id="assignee-row" style="gap: 8px; margin-top: 16px; display: none; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 4px;">
            <label style="font-weight: 500;">Reassign To</label>
            <select id="sel-assignee" class="input" style="max-width: 240px">
              <option value="">-- Select Agent --</option>
            </select>
            <button class="btn secondary" id="btn-reassign">Reassign</button>
            <span id="assign-ok" class="badge" style="display: none">Reassigned</span>
            <span id="assign-err" class="badge" style="display: none"
              >Reassign failed</span
            >
          </div>
        </div>

        <!-- Comments card -->
        <div class="card">
          <h3 style="margin-top: 0">Comments</h3>
          <div id="comments"></div>

          <div class="row" style="margin-top: 10px; align-items: stretch">
            <input
              class="input"
              id="new-comment"
              placeholder="Add a comment..."
            />
            <button class="btn" id="btn-add-comment">Comment</button>
            <span id="c-ok" class="badge" style="display: none">Added</span>
            <span id="c-err" class="badge" style="display: none">Failed</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/guard.js"></script>

    <script>
      addDefaultNav("nav-actions");

      const idParam = new URLSearchParams(location.search).get("id");
      if (!idParam) {
        alert("Missing ticket id");
        location.href = "./tickets.html";
      }

      // Hide/show controls based on user role
      let currentUser = null;
      
      // Function to show reassignment UI
      async function showReassignmentUI() {
        const assigneeRow = document.getElementById("assignee-row");
        if (!assigneeRow) {
          console.error("[Ticket Detail] assignee-row element not found!");
          return;
        }
        
        assigneeRow.style.display = "flex";
        console.log("[Ticket Detail] Assignee row displayed");
        
        // Load agents for dropdown
        const select = document.getElementById("sel-assignee");
        if (!select) {
          console.error("[Ticket Detail] sel-assignee element not found!");
          return;
        }
        
        // Wait for Users API to be available
        let retries = 10;
        while (retries > 0 && (typeof Users === 'undefined' || !Users.getAgents)) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries--;
        }
        
        if (typeof Users !== 'undefined' && Users.getAgents) {
          try {
            console.log("[Ticket Detail] Loading agents...");
            const agents = await Users.getAgents();
            console.log("[Ticket Detail] Loaded agents:", agents.length);
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">-- Select Agent --</option>';
            
            agents.forEach(agent => {
              const option = document.createElement("option");
              option.value = agent.id;
              option.textContent = `${agent.name} (${agent.email})`;
              select.appendChild(option);
            });
            console.log("[Ticket Detail] Agents added to dropdown");
          } catch (e) {
            console.error("[Ticket Detail] Failed to load agents:", e);
          }
        } else {
          console.error("[Ticket Detail] Users API not available after retries. typeof Users:", typeof Users);
        }
      }
      
      (async () => {
        try {
          currentUser = await Auth.me();
          console.log("[Ticket Detail] Current user:", currentUser);
          const isStaff =
            currentUser && ["admin", "agent", "supervisor"].includes(currentUser.role);
          const isAdmin = currentUser && currentUser.role === "admin";
          
          console.log("[Ticket Detail] isStaff:", isStaff, "isAdmin:", isAdmin, "role:", currentUser?.role);
          
          if (!isStaff) {
            const row =
              document.getElementById("sel-status")?.closest(".row") ||
              document.getElementById("status-row");
            if (row) row.style.display = "none";
          }
          
          // Show assignee reassignment only for admins
          if (isAdmin) {
            console.log("[Ticket Detail] Admin detected, showing reassignment UI");
            await showReassignmentUI();
          } else {
            console.log("[Ticket Detail] Not admin, role:", currentUser?.role);
          }
        } catch (e) {
          console.error("[Ticket Detail] Auth check failed:", e);
          // if /auth/me fails, treat as non-staff
          const row =
            document.getElementById("sel-status")?.closest(".row") ||
            document.getElementById("status-row");
          if (row) row.style.display = "none";
        }
      })();

      let ticket;

      (async () => {
        try {
          ticket = await API.getTicket(idParam);
          if (!ticket) throw new Error("Ticket not found");

          byId("t-title").textContent = ticket.title || "(no title)";
          byId("t-id").textContent = `#${ticket.id}`;
          byId("t-priority").textContent = ticket.priority || "Low";
          byId("t-category").textContent = ticket.category || "General";
          byId("t-status").textContent = ticket.status || "New";
          byId("t-desc").textContent = ticket.description || "";
          byId("sel-status").value = ticket.status || "New";
          
          // Display current assignee
          const assigneeDisplay = byId("t-assignee-display");
          if (assigneeDisplay) {
            const assigneeName = ticket.assigneeName || ticket.assigneeEmail || ticket.assignee || "Unassigned";
            assigneeDisplay.textContent = assigneeName;
          }
          
          // Set current assignee in dropdown if admin
          if (currentUser && currentUser.role === "admin" && ticket.assignee) {
            const select = byId("sel-assignee");
            if (select) select.value = ticket.assignee;
          }

          renderComments(ticket.comments || []);
        } catch (e) {
          console.error(e);
          alert("Failed to load ticket");
          location.href = "./tickets.html";
        }
      })();

      function renderComments(list) {
        const el = byId("comments");
        el.innerHTML = "";
        if (!list || !list.length) {
          el.innerHTML = '<div class="muted">No comments yet.</div>';
          return;
        }
        list.forEach((c) => {
          const div = document.createElement("div");
          div.className = "card";
          div.style.margin = "8px 0";
          const when = c.createdAt
            ? new Date(c.createdAt).toLocaleString()
            : "";
          div.innerHTML = `<div class="muted">${when}</div><div>${escapeHtml(
            c.text || ""
          )}</div>`;
          el.appendChild(div);
        });
      }

      // Status update
      byId("btn-update-status").addEventListener("click", async () => {
        const btn = byId("btn-update-status");
        const ok = byId("save-ok");
        const err = byId("save-err");
        err.style.display = "none";
        btn.disabled = true;
        try {
          const status = val("sel-status");
          const updated = await API.updateTicket(idParam, { status });
          byId("t-status").textContent = (updated && updated.status) || status;
          showBadge(ok);
        } catch (e) {
          console.error(e);
          err.textContent = "Save failed";
          err.style.display = "inline-block";
          // revert select to previous
          byId("sel-status").value = byId("t-status").textContent;
        } finally {
          btn.disabled = false;
        }
      });

      // Reassign ticket (admin only)
      const btnReassign = byId("btn-reassign");
      if (btnReassign) {
        btnReassign.addEventListener("click", async () => {
          const btn = byId("btn-reassign");
          const ok = byId("assign-ok");
          const err = byId("assign-err");
          err.style.display = "none";
          btn.disabled = true;
          
          const assigneeId = val("sel-assignee");
          if (!assigneeId) {
            err.textContent = "Please select an agent";
            err.style.display = "inline-block";
            btn.disabled = false;
            return;
          }
          
          try {
            const updated = await API.updateTicket(idParam, { assignee: assigneeId });
            // Reload ticket to get updated assignee name/email
            ticket = await API.getTicket(idParam);
            if (ticket) {
              const assigneeDisplay = byId("t-assignee-display");
              if (assigneeDisplay) {
                const assigneeName = ticket.assigneeName || ticket.assigneeEmail || ticket.assignee || "Unassigned";
                assigneeDisplay.textContent = assigneeName;
              }
              // Update dropdown selection
              const select = byId("sel-assignee");
              if (select) select.value = ticket.assignee || "";
            }
            showBadge(ok);
          } catch (e) {
            console.error(e);
            err.textContent = "Reassign failed";
            err.style.display = "inline-block";
          } finally {
            btn.disabled = false;
          }
        });
      }

      // Add comment
      byId("btn-add-comment").addEventListener("click", async () => {
        const btn = byId("btn-add-comment");
        const ok = byId("c-ok");
        const err = byId("c-err");
        err.style.display = "none";

        const text = val("new-comment").trim();
        if (!text) return;

        btn.disabled = true;
        try {
          const updated = await API.addComment(idParam, text);
          byId("new-comment").value = "";
          renderComments((updated && updated.comments) || []);
          showBadge(ok);
          // scroll to newest
          const list = byId("comments");
          list.lastElementChild &&
            list.lastElementChild.scrollIntoView({
              behavior: "smooth",
              block: "end",
            });
        } catch (e) {
          console.error(e);
          err.textContent = "Failed";
          err.style.display = "inline-block";
        } finally {
          btn.disabled = false;
        }
      });

      function showBadge(el) {
        el.style.display = "inline-block";
        setTimeout(() => (el.style.display = "none"), 1200);
      }
    </script>
  </body>
</html>
