<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Ticket</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <div class="container">
      <div class="nav">
        <div class="brand"><a href="../index.html">← Back</a></div>
        <div id="nav-actions"></div>
      </div>

      <div class="card">
        <h2 style="margin-top: 0" data-i18n="tickets.newBtn">+ New Ticket</h2>

        <div class="grid grid-2">
          <div>
            <label data-i18n="tickets.title">Tickets</label>
            <input id="t-title" class="input" placeholder="Short summary" />
          </div>

          <div>
            <label data-i18n="tickets.priority">Priority</label>
            <select id="t-priority" class="input">
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
              <option>Critical</option>
            </select>
          </div>

          <div>
            <label data-i18n="reports.byCategory">By Category</label>
            <select id="t-category" class="input">
              <option>Software</option>
              <option>Hardware</option>
              <option>Network</option>
              <option>Access</option>
            </select>
          </div>

          <div>
            <label data-i18n="ticket.departmentLabel">Affected Department</label>
            <select id="t-dept" class="input"></select>
          </div>

          <div style="grid-column: span 2">
            <label>Description</label>
            <textarea
              id="t-desc"
              class="input"
              rows="6"
              placeholder="Describe the problem"
            ></textarea>
          </div>
        </div>

        <div class="row" style="margin-top: 12px; justify-content: flex-end">
          <button class="btn ghost" onclick="location.href='../index.html'">
            <span data-i18n="btn.cancel">Cancel</span>
          </button>
          <button class="btn" id="btn-create"><span data-i18n="btn.create">Create</span></button>

          <!-- Feedback Badges -->
          <span
            id="msg-ok"
            class="badge"
            style="display: none; margin-left: 8px"
            ><span data-i18n="btn.create">Created</span></span
          >
          <span
            id="msg-err"
            class="badge"
            style="display: none; margin-left: 8px"
            >Failed</span
          >
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/i18n.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/guard.js"></script>

    <script>
      addDefaultNav("nav-actions");

      const btn = document.getElementById("btn-create");
      const okEl = document.getElementById("msg-ok");
      const errEl = document.getElementById("msg-err");
      const selPriority = document.getElementById("t-priority");
      const selCategory = document.getElementById("t-category");
      const selDepartment = document.getElementById("t-dept");

      const DEPARTMENTS = [
        "სათაო",
        "ბაღდათის მრავალპროფილური სამედიცინო ცენტრი",
        "ბორჯომის მრავალპროფილური სამედიცინო ცენტრი",
        "გარდაბნის მრავალპროფილური სამედიცინო ცენტრი",
        "გურჯაანის მრავალპროფილური სამედიცინო ცენტრი",
        "დუშეთის მრავალპროფილური სამედიცინო ცენტრი",
        "ვანის სამედიცინო ცენტრი",
        "ზესტაფონის ამბულატორიული ცენტრი",
        "ზესტაფონის მრავალპროფილური სამედიცინო ცენტრი",
        "თბილისის მრავალპროფილური სამედიცინო ცენტრი",
        "იორმუღანლოს ამბულატორია",
        "მარნეულის მრავალპროფილური სამედიცინო ცენტრი",
        "მარნეულის სამშობიარო და ამბულატორიული ცენტრი",
        "მცხეთის მრავალპროფილური სამედიცინო ცენტრი",
        "საგარეჯოს მრავალპროფილური სამედიცინო ცენტრი",
        "სადახლოს ამბულატორია",
        "სამტრედიის ამბულატორიული ცენტრი",
        "სამტრედიის მრავალპროფილური სამედიცინო ცენტრი",
        "სართიჭალის ამბულატორია",
        "ქუთაისის ცენტრალური საავადმყოფო",
        "ჭიათურის ამბულატორიული ცენტრი",
        "ჭიათურის მრავალპროფილური სამედიცინო ცენტრი",
        "ხონის ამბულატორიული ცენტრი"
      ];

      // Apply localization to select options on load and when language changes
      function applyCreatePageI18n() {
        try {
          // Priorities via i18n mapper
          const prios = ["Low", "Medium", "High", "Critical"];
          if (selPriority) {
            const current = selPriority.value || "Low";
            selPriority.innerHTML = prios
              .map((p) => `<option value="${p}">${escapeHtml(I18n.mapPriority(p))}</option>`)
              .join("");
            selPriority.value = current;
          }
          if (selDepartment) {
            const currentD = selDepartment.value;
            const placeholder = (I18n && I18n.t && I18n.t("ticket.selectDepartment")) || "Select Department";
            const options = [
              `<option value="" disabled ${currentD ? "" : "selected"}>${escapeHtml(placeholder)}</option>`,
              ...DEPARTMENTS.map((dept) => `<option value="${escapeHtml(dept)}">${escapeHtml(dept)}</option>`)
            ];
            selDepartment.innerHTML = options.join("");
            if (currentD && DEPARTMENTS.includes(currentD)) {
              selDepartment.value = currentD;
            }
          }
          // Categories (simple inline map)
          const catMap = {
            Software: { en: "Software", ka: "პროგრამული უზრუნველყოფა" },
            Hardware: { en: "Hardware", ka: "ფიზიკური მოწყობილობა" },
            Network: { en: "Network", ka: "ქსელი" },
            Access: { en: "Access", ka: "წვდომა" }
          };
          if (selCategory) {
            const currentC = selCategory.value || "Software";
            const lang = (I18n && I18n.getLang && I18n.getLang()) || "en";
            const cats = Object.keys(catMap);
            selCategory.innerHTML = cats
              .map((c) => `<option value="${c}">${escapeHtml(catMap[c][lang] || c)}</option>`)
              .join("");
            selCategory.value = currentC;
          }
          // Re-apply data-i18n text in this card (in case navbar injection reset timing)
          if (window.I18n && typeof window.I18n.setLang === "function") {
            // setLang(getLang()) is idempotent and re-applies translations
            I18n.setLang(I18n.getLang());
          }
        } catch (e) {
          console.warn("[i18n] create-page apply failed:", e);
        }
      }
      document.addEventListener("DOMContentLoaded", applyCreatePageI18n);
      if (window.I18n && typeof I18n.onChange === "function") {
        I18n.onChange(applyCreatePageI18n);
      }

      function show(el) {
        el.style.display = "inline-block";
        setTimeout(() => (el.style.display = "none"), 1200);
      }

      async function handleCreate(e) {
        if (e) e.preventDefault();
        errEl.style.display = "none";
        btn.disabled = true;

        const t = {
          title: val("t-title").trim(),
          description: val("t-desc").trim(),
          category: val("t-category").trim(),
          priority: val("t-priority"),
          department: val("t-dept").trim(),
        };

        if (!t.title) {
          errEl.textContent = "Title is required";
          errEl.style.display = "inline-block";
          btn.disabled = false;
          return;
        }

        try {
          const created = await API.createTicket(t);
          show(okEl);
          const ticketId = (created && (created.id || (created.ticket && created.ticket.id))) || "";
          if (!ticketId) {
            console.error("[Create] Missing ticket id in response:", created);
            alert("Create succeeded, but ticket ID was missing. Redirecting to list.");
            location.href = "./tickets.html";
            return;
          }
          try {
            await API.getTicket(ticketId);
            location.href = `./ticket-detail.html?id=${encodeURIComponent(ticketId)}`;
          } catch (e2) {
            setTimeout(() => {
              location.href = `./ticket-detail.html?id=${encodeURIComponent(ticketId)}`;
            }, 250);
          }
        } catch (e) {
          console.error(e);
          errEl.textContent = "Failed to create ticket";
          errEl.style.display = "inline-block";
        } finally {
          btn.disabled = false;
        }
      }

      btn.addEventListener("click", handleCreate);

      // Allow Enter to submit if wrapped in a form in future
      document.addEventListener("submit", (e) => {
        if (e.target.closest(".card")) handleCreate(e);
      });
    </script>
  </body>
</html>
