<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - IT Ticketing</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <div class="container">
      <div
        class="card"
        style="max-width: 420px; margin: 60px auto; padding: 24px"
      >
        <h2 style="margin-bottom: 4px">Sign in</h2>
        <p class="muted" style="margin-bottom: 16px">
          Use your AD credentials to continue.
        </p>

        <form
          id="login-form"
          class="grid"
          onsubmit="return false;"
          style="gap: 12px"
        >
          <input
            class="input"
            id="email"
            placeholder="Email"
            value=""
          />
          <input
            class="input"
            id="password"
            type="password"
            placeholder="Password"
            value=""
          />
          <button class="btn" id="btn-login">Login</button>
        </form>

        <div
          id="login-error"
          class="badge"
          style="margin-top: 10px; display: none"
        >
          Invalid credentials
        </div>

        <!-- Register link section -->
        <div style="text-align: center; margin-top: 16px">
          <span class="muted">Don't have an account?</span>
          <a href="./register.html" class="btn ghost" style="margin-left: 6px">
            Register
          </a>
        </div>
      </div>
    </div>

    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/i18n.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      (function () {
        const form = document.getElementById("login-form");
        const btn = document.getElementById("btn-login");
        const err = document.getElementById("login-error");
        const emailEl = document.getElementById("email");
        const passEl = document.getElementById("password");

        // Helper to show/hide error badge
        function showError(msg) {
          err.textContent = msg || "Invalid credentials";
          err.style.display = "inline-block";
        }
        function hideError() {
          err.style.display = "none";
        }

        async function doLogin(e) {
          if (e) e.preventDefault();
          hideError();
          btn.disabled = true;

          const email = emailEl.value.trim();
          const password = passEl.value;

          try {
            const res = await fetch("/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include", // keep cookies
              body: JSON.stringify({ email, password }),
            });

            let data = null;
            try {
              data = await res.json();
            } catch (_) {}

            if (res.ok) {
              window.location.href = "../index.html";
            } else {
              showError(
                (data && (data.error || data.message)) || "Invalid credentials"
              );
            }
          } catch (ex) {
            showError("Network error. Please try again.");
          } finally {
            btn.disabled = false;
          }
        }

        btn.addEventListener("click", doLogin);
        form.addEventListener("submit", doLogin);
      })();
    </script>
  </body>
</html>
